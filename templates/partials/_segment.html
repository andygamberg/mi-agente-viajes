{#
  Partial para renderizar un segmento de reserva.
  Usa datos JSONB con fallback a columnas legacy.

  Recibe: vuelo (objeto Viaje)
#}
{% set d = vuelo.datos or {} %}
{% set tipo = vuelo.tipo or 'vuelo' %}

<div class="segment-content">
    {# Menú kebab de acciones #}
    <div class="segment-actions">
        <button type="button" class="btn-kebab" onclick="toggleSegmentMenu(event, this)" title="Acciones">
            <svg class="icon-sm" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
            </svg>
        </button>
        <div class="segment-menu" onclick="event.stopPropagation()">
            {% if vuelo._es_combinado and vuelo._codigos_reserva and vuelo._reservas_combinadas %}
                {# Múltiples reservas: iterar por códigos para mantener orden correcto #}
                {% for codigo in vuelo._codigos_reserva %}
                    {# Buscar la reserva con este código #}
                    {% for reserva in vuelo._reservas_combinadas %}
                        {% if (reserva.codigo_reserva or 'N/A') == codigo %}
                <a href="{{ url_for('viajes.editar', id=reserva.id) }}" class="segment-menu-item">
                    <svg class="icon-sm" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14.846 1.403a2.081 2.081 0 0 1 3.02 2.857l-9.134 9.634a2.5 2.5 0 0 1-1.205.653l-2.93.61a.5.5 0 0 1-.593-.593l.61-2.93a2.5 2.5 0 0 1 .653-1.205l9.58-9.026z"/>
                    </svg>
                    Editar {{ codigo if codigo != 'N/A' else 'reserva ' ~ loop.index }}
                </a>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% else %}
                {# Reserva única: opción simple #}
                <a href="{{ url_for('viajes.editar', id=vuelo.id) }}" class="segment-menu-item">
                    <svg class="icon-sm" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14.846 1.403a2.081 2.081 0 0 1 3.02 2.857l-9.134 9.634a2.5 2.5 0 0 1-1.205.653l-2.93.61a.5.5 0 0 1-.593-.593l.61-2.93a2.5 2.5 0 0 1 .653-1.205l9.58-9.026z"/>
                    </svg>
                    Editar reserva
                </a>
            {% endif %}

            {# Futuro: más opciones aquí #}
            {# <a href="#" class="segment-menu-item">Eliminar</a> #}
            {# <a href="#" class="segment-menu-item">Compartir</a> #}
        </div>
    </div>
    {# ========== VUELO ========== #}
    {% if tipo == 'vuelo' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or vuelo.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or vuelo.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.aerolinea or d.numero_vuelo %}
                <span class="detail">{{ d.aerolinea or '' }} {{ d.numero_vuelo or '' }}</span>
            {% endif %}
            {% if d.hora_salida %}
                <span class="detail">Salida: {{ d.hora_salida }}{% if d.terminal %} · Terminal {{ d.terminal }}{% endif %}{% if d.puerta %} · Puerta {{ d.puerta }}{% endif %}</span>
            {% endif %}
            {% if d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_llegada }}</span>
            {% endif %}
            {% if d.codigo_reserva and not vuelo._es_combinado %}
                <span class="detail">Reserva: {{ d.codigo_reserva }}</span>
            {% endif %}
        </div>

        {# Pasajeros combinados (de múltiples reservas) #}
        {% if vuelo._es_combinado and vuelo._pasajeros_combinados and vuelo._pasajeros_combinados|length > 0 %}
            <div class="passengers-list">
                {% for codigo, paxs in vuelo._pasajeros_combinados|groupby('codigo_reserva') %}
                    <div class="reserva-group">
                        <div class="reserva-header">{{ codigo }}</div>
                        {% for p in paxs %}
                            <div class="passenger-card">
                                <div class="passenger-name">{{ p.nombre }}</div>
                                <div class="passenger-meta">
                                    {% if p.asiento %}<span class="meta-badge">{{ p.asiento }}</span>{% endif %}
                                    {% if p.cabina %}<span class="meta-badge">{{ p.cabina }}</span>{% endif %}
                                    {% if p.viajero_frecuente %}<span class="meta-badge">{{ p.viajero_frecuente }}</span>{% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {# Pasajeros normales (reserva única) - desde datos JSONB #}
        {% elif d.pasajeros and d.pasajeros|length > 0 %}
            <div class="passengers-list">
                {% for p in d.pasajeros %}
                    <div class="passenger-card">
                        {% if p is mapping %}
                            <div class="passenger-name">{{ p.nombre }}</div>
                            <div class="passenger-meta">
                                {% if p.asiento %}<span class="meta-badge">{{ p.asiento }}</span>{% endif %}
                                {% if p.cabina %}<span class="meta-badge">{{ p.cabina }}</span>{% endif %}
                                {% if p.viajero_frecuente %}<span class="meta-badge">{{ p.viajero_frecuente }}</span>{% endif %}
                            </div>
                        {% else %}
                            <div class="passenger-name">{{ p }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {# Equipaje #}
        {% if d.equipaje_facturado or d.equipaje_mano %}
            <div class="segment-footer">
                {% if d.equipaje_facturado %}<span class="detail">Bodega: {{ d.equipaje_facturado }}</span>{% endif %}
                {% if d.equipaje_mano %}<span class="detail">Cabina: {{ d.equipaje_mano }}</span>{% endif %}
            </div>
        {% endif %}

    {# ========== HOTEL ========== #}
    {% elif tipo == 'hotel' %}
        <div class="segment-main">
            <span class="detail-label">Hotel:</span>
            <span class="detail-value">{{ d.nombre_propiedad or vuelo.proveedor or 'Hotel' }}</span>
        </div>
        {% if d.direccion or vuelo.ubicacion %}
            <div class="segment-details">
                <span class="detail">{{ d.direccion or vuelo.ubicacion }}</span>
            </div>
        {% endif %}
        <div class="segment-dates">
            {% if d.fecha_checkin %}
                <span class="detail">Check-in: {{ d.fecha_checkin }}{% if d.hora_checkin %} {{ d.hora_checkin }}{% endif %}</span>
            {% endif %}
            {% if d.fecha_checkout %}
                <span class="detail">Check-out: {{ d.fecha_checkout }}{% if d.hora_checkout %} {{ d.hora_checkout }}{% endif %}</span>
            {% endif %}
        </div>

    {# ========== CRUCERO / FERRY ========== #}
    {% elif tipo in ['crucero', 'barco'] %}
        <div class="segment-route">
            <span class="route-point">{{ d.puerto_embarque or vuelo.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.puerto_desembarque or vuelo.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.hora_embarque %}
                <span class="detail">Embarque: {{ d.hora_embarque }}</span>
            {% endif %}
            {% if d.hora_desembarque or d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_desembarque or d.hora_llegada }}</span>
            {% endif %}
            {% if d.clase %}
                <span class="detail">Clase: {{ d.clase }}</span>
            {% endif %}
            {% if d.embarcacion %}
                <span class="detail">Embarcación: {{ d.embarcacion }}</span>
            {% endif %}
        </div>
        {# Vehículos #}
        {% if d.vehiculo or d.vehiculos %}
            <div class="segment-vehicles">
                <span class="vehicle-label">Vehículo:</span>
                {% if d.vehiculo %}
                    <span class="meta-badge">{{ d.vehiculo }}</span>
                {% elif d.vehiculos %}
                    {% for v in d.vehiculos %}
                        <span class="meta-badge">{{ v.patente if v is mapping else v }}</span>
                    {% endfor %}
                {% endif %}
            </div>
        {% endif %}

        {# Pasajeros combinados (de múltiples reservas) #}
        {% if vuelo._es_combinado and vuelo._pasajeros_combinados and vuelo._pasajeros_combinados|length > 0 %}
            <div class="passengers-list">
                {% for codigo, paxs in vuelo._pasajeros_combinados|groupby('codigo_reserva') %}
                    <div class="reserva-group">
                        <div class="reserva-header">{{ codigo }}</div>
                        {% for p in paxs %}
                            <div class="passenger-card">
                                <div class="passenger-name">{{ p.nombre }}</div>
                                {% if p.ticket %}
                                    <div class="passenger-meta">
                                        <span class="meta-badge">{{ p.ticket }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {# Pasajeros normales (reserva única) #}
        {% elif d.pasajeros and (d.pasajeros is iterable and d.pasajeros is not string) and d.pasajeros|length > 0 %}
            <div class="passengers-list">
                {% for p in d.pasajeros %}
                    <div class="passenger-card">
                        {% if p is mapping %}
                            <div class="passenger-name">{{ p.nombre }}</div>
                            {% if p.ticket %}
                                <div class="passenger-meta">
                                    <span class="meta-badge">{{ p.ticket }}</span>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="passenger-name">{{ p }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

    {# ========== AUTO ========== #}
    {% elif tipo == 'auto' %}
        <div class="segment-route">
            <span class="route-point">{{ d.lugar_retiro or vuelo.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.lugar_devolucion or vuelo.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.empresa %}
                <span class="detail">{{ d.empresa }}</span>
            {% endif %}
            {% if d.modelo or d.categoria %}
                <span class="detail">{{ d.modelo or d.categoria }}</span>
            {% endif %}
            {% if d.hora_retiro %}
                <span class="detail">Retiro: {{ d.hora_retiro }}</span>
            {% endif %}
        </div>

    {# ========== RESTAURANTE ========== #}
    {% elif tipo == 'restaurante' %}
        <div class="segment-main">
            <span class="detail-value">{{ d.nombre or vuelo.proveedor or 'Restaurante' }}</span>
        </div>
        <div class="segment-details">
            {% if d.direccion or vuelo.ubicacion %}
                <span class="detail">{{ d.direccion or vuelo.ubicacion }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
            {% if d.comensales %}
                <span class="detail">{{ d.comensales }} comensales</span>
            {% endif %}
        </div>

    {# ========== ESPECTÁCULO ========== #}
    {% elif tipo == 'espectaculo' %}
        <div class="segment-main">
            <span class="detail-value">{{ d.evento or vuelo.descripcion or 'Espectáculo' }}</span>
        </div>
        <div class="segment-details">
            {% if d.venue or vuelo.ubicacion %}
                <span class="detail">{{ d.venue or vuelo.ubicacion }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
            {% if d.sector %}
                <span class="detail">Sector: {{ d.sector }}</span>
            {% endif %}
            {% if d.entradas %}
                <span class="detail">{{ d.entradas }} entradas</span>
            {% endif %}
        </div>
        {# Detalles de entradas #}
        {% if d.detalles_entradas and d.detalles_entradas|length > 0 %}
            <div class="segment-tickets">
                {% for e in d.detalles_entradas %}
                    <span class="ticket-badge">
                        {% if e.fila %}Fila {{ e.fila }}{% endif %}
                        {% if e.asiento %} - Asiento {{ e.asiento }}{% endif %}
                    </span>
                {% endfor %}
            </div>
        {% endif %}

    {# ========== ACTIVIDAD ========== #}
    {% elif tipo == 'actividad' %}
        <div class="segment-main">
            <span class="detail-value">{{ d.nombre or vuelo.descripcion or 'Actividad' }}</span>
        </div>
        <div class="segment-details">
            {% if d.punto_encuentro %}
                <span class="detail">{{ d.punto_encuentro }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
            {% if d.duracion %}
                <span class="detail">Duración: {{ d.duracion }}</span>
            {% endif %}
        </div>

    {# ========== TREN ========== #}
    {% elif tipo == 'tren' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or vuelo.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or vuelo.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.operador %}
                <span class="detail">{{ d.operador }}</span>
            {% endif %}
            {% if d.hora_salida %}
                <span class="detail">Salida: {{ d.hora_salida }}</span>
            {% endif %}
            {% if d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_llegada }}</span>
            {% endif %}
        </div>

    {# ========== BUS ========== #}
    {% elif tipo == 'bus' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or vuelo.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or vuelo.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.empresa %}
                <span class="detail">{{ d.empresa }}</span>
            {% endif %}
            {% if d.hora_salida %}
                <span class="detail">Salida: {{ d.hora_salida }}</span>
            {% endif %}
            {% if d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_llegada }}</span>
            {% endif %}
            {% if d.codigo_reserva %}
                <span class="detail">Reserva: {{ d.codigo_reserva }}</span>
            {% endif %}
        </div>

        {# Pasajeros combinados (de múltiples reservas) #}
        {% if vuelo._es_combinado and vuelo._pasajeros_combinados and vuelo._pasajeros_combinados|length > 0 %}
            <div class="passengers-list">
                {% for codigo, paxs in vuelo._pasajeros_combinados|groupby('codigo_reserva') %}
                    <div class="reserva-group">
                        <div class="reserva-header">{{ codigo }}</div>
                        {% for p in paxs %}
                            <div class="passenger-card">
                                <div class="passenger-name">{{ p.nombre }}</div>
                                {% if p.asiento %}
                                    <div class="passenger-meta">
                                        <span class="meta-badge">{{ p.asiento }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {# Pasajeros normales (reserva única) #}
        {% elif d.pasajeros and (d.pasajeros is iterable and d.pasajeros is not string and d.pasajeros is not number) and d.pasajeros|length > 0 %}
            <div class="passengers-list">
                {% for p in d.pasajeros %}
                    <div class="passenger-card">
                        <div class="passenger-name">{{ p.nombre if p is mapping else p }}</div>
                        {% if p is mapping and p.asiento %}
                            <div class="passenger-meta">Asiento: {{ p.asiento }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

    {# ========== TRANSFER ========== #}
    {% elif tipo == 'transfer' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or vuelo.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or vuelo.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.empresa %}
                <span class="detail">{{ d.empresa }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
        </div>

    {# ========== DEFAULT ========== #}
    {% else %}
        <div class="segment-main">
            <span class="detail-value">{{ d.descripcion or vuelo.descripcion or 'Reserva' }}</span>
        </div>
        {% if vuelo.origen and vuelo.destino %}
            <div class="segment-route">
                <span class="route-point">{{ vuelo.origen }}</span>
                <span class="route-arrow">→</span>
                <span class="route-point">{{ vuelo.destino }}</span>
            </div>
        {% endif %}
    {% endif %}
</div>
