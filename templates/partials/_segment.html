{#
  Partial para renderizar un segmento de reserva.
  Usa datos JSONB con fallback a columnas legacy.

  Recibe: viaje (objeto Viaje)
#}
{% set d = viaje.datos or {} %}
{% set tipo = viaje.tipo or 'vuelo' %}

<div class="segment-content">
    {# ========== VUELO ========== #}
    {% if tipo == 'vuelo' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or viaje.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or viaje.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.aerolinea or d.numero_vuelo %}
                <span class="detail">{{ d.aerolinea or '' }} {{ d.numero_vuelo or '' }}</span>
            {% endif %}
            {% if d.hora_salida %}
                <span class="detail">Salida: {{ d.hora_salida }}</span>
            {% endif %}
            {% if d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_llegada }}</span>
            {% endif %}
            {% if d.codigo_reserva %}
                <span class="detail">Reserva: {{ d.codigo_reserva }}</span>
            {% endif %}
        </div>
        {% if d.pasajeros and d.pasajeros|length > 0 %}
            <div class="segment-passengers">
                {% for p in d.pasajeros %}
                    <span class="passenger-badge">{{ p.nombre if p is mapping else p }}{% if p is mapping and p.asiento %} ({{ p.asiento }}){% endif %}</span>
                {% endfor %}
            </div>
        {% endif %}

    {# ========== HOTEL ========== #}
    {% elif tipo == 'hotel' %}
        <div class="segment-main">
            <span class="detail-label">Hotel:</span>
            <span class="detail-value">{{ d.nombre_propiedad or viaje.proveedor or 'Hotel' }}</span>
        </div>
        {% if d.direccion or viaje.ubicacion %}
            <div class="segment-details">
                <span class="detail">{{ d.direccion or viaje.ubicacion }}</span>
            </div>
        {% endif %}
        <div class="segment-dates">
            {% if d.fecha_checkin %}
                <span class="detail">Check-in: {{ d.fecha_checkin }}{% if d.hora_checkin %} {{ d.hora_checkin }}{% endif %}</span>
            {% endif %}
            {% if d.fecha_checkout %}
                <span class="detail">Check-out: {{ d.fecha_checkout }}{% if d.hora_checkout %} {{ d.hora_checkout }}{% endif %}</span>
            {% endif %}
        </div>

    {# ========== CRUCERO / FERRY ========== #}
    {% elif tipo in ['crucero', 'barco'] %}
        <div class="segment-route">
            <span class="route-point">{{ d.puerto_embarque or viaje.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.puerto_desembarque or viaje.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.hora_embarque %}
                <span class="detail">Embarque: {{ d.hora_embarque }}</span>
            {% endif %}
            {% if d.hora_desembarque or d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_desembarque or d.hora_llegada }}</span>
            {% endif %}
            {% if d.clase %}
                <span class="detail">Clase: {{ d.clase }}</span>
            {% endif %}
            {% if d.embarcacion %}
                <span class="detail">Embarcación: {{ d.embarcacion }}</span>
            {% endif %}
        </div>
        {# Vehículos #}
        {% if d.vehiculo or d.vehiculos %}
            <div class="segment-vehicles">
                <span class="detail-label">Vehículo:</span>
                {% if d.vehiculo %}
                    <span class="vehicle-badge">{{ d.vehiculo }}</span>
                {% elif d.vehiculos %}
                    {% for v in d.vehiculos %}
                        <span class="vehicle-badge">{{ v.patente if v is mapping else v }}</span>
                    {% endfor %}
                {% endif %}
            </div>
        {% endif %}
        {# Pasajeros #}
        {% if d.pasajeros and d.pasajeros|length > 0 %}
            <div class="segment-passengers">
                {% for p in d.pasajeros %}
                    <span class="passenger-badge">{{ p.nombre if p is mapping else p }}</span>
                {% endfor %}
            </div>
        {% endif %}

    {# ========== AUTO ========== #}
    {% elif tipo == 'auto' %}
        <div class="segment-route">
            <span class="route-point">{{ d.lugar_retiro or viaje.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.lugar_devolucion or viaje.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.empresa %}
                <span class="detail">{{ d.empresa }}</span>
            {% endif %}
            {% if d.modelo or d.categoria %}
                <span class="detail">{{ d.modelo or d.categoria }}</span>
            {% endif %}
            {% if d.hora_retiro %}
                <span class="detail">Retiro: {{ d.hora_retiro }}</span>
            {% endif %}
        </div>

    {# ========== RESTAURANTE ========== #}
    {% elif tipo == 'restaurante' %}
        <div class="segment-main">
            <span class="detail-value">{{ d.nombre or viaje.proveedor or 'Restaurante' }}</span>
        </div>
        <div class="segment-details">
            {% if d.direccion or viaje.ubicacion %}
                <span class="detail">{{ d.direccion or viaje.ubicacion }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
            {% if d.comensales %}
                <span class="detail">{{ d.comensales }} comensales</span>
            {% endif %}
        </div>

    {# ========== ESPECTÁCULO ========== #}
    {% elif tipo == 'espectaculo' %}
        <div class="segment-main">
            <span class="detail-value">{{ d.evento or viaje.descripcion or 'Espectáculo' }}</span>
        </div>
        <div class="segment-details">
            {% if d.venue or viaje.ubicacion %}
                <span class="detail">{{ d.venue or viaje.ubicacion }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
            {% if d.sector %}
                <span class="detail">Sector: {{ d.sector }}</span>
            {% endif %}
            {% if d.entradas %}
                <span class="detail">{{ d.entradas }} entradas</span>
            {% endif %}
        </div>
        {# Detalles de entradas #}
        {% if d.detalles_entradas and d.detalles_entradas|length > 0 %}
            <div class="segment-tickets">
                {% for e in d.detalles_entradas %}
                    <span class="ticket-badge">
                        {% if e.fila %}Fila {{ e.fila }}{% endif %}
                        {% if e.asiento %} - Asiento {{ e.asiento }}{% endif %}
                    </span>
                {% endfor %}
            </div>
        {% endif %}

    {# ========== ACTIVIDAD ========== #}
    {% elif tipo == 'actividad' %}
        <div class="segment-main">
            <span class="detail-value">{{ d.nombre or viaje.descripcion or 'Actividad' }}</span>
        </div>
        <div class="segment-details">
            {% if d.punto_encuentro %}
                <span class="detail">{{ d.punto_encuentro }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
            {% if d.duracion %}
                <span class="detail">Duración: {{ d.duracion }}</span>
            {% endif %}
        </div>

    {# ========== TREN ========== #}
    {% elif tipo == 'tren' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or viaje.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or viaje.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.operador %}
                <span class="detail">{{ d.operador }}</span>
            {% endif %}
            {% if d.hora_salida %}
                <span class="detail">Salida: {{ d.hora_salida }}</span>
            {% endif %}
            {% if d.hora_llegada %}
                <span class="detail">Llegada: {{ d.hora_llegada }}</span>
            {% endif %}
        </div>

    {# ========== TRANSFER ========== #}
    {% elif tipo == 'transfer' %}
        <div class="segment-route">
            <span class="route-point">{{ d.origen or viaje.origen or '?' }}</span>
            <span class="route-arrow">→</span>
            <span class="route-point">{{ d.destino or viaje.destino or '?' }}</span>
        </div>
        <div class="segment-details">
            {% if d.empresa %}
                <span class="detail">{{ d.empresa }}</span>
            {% endif %}
            {% if d.hora %}
                <span class="detail">Hora: {{ d.hora }}</span>
            {% endif %}
        </div>

    {# ========== DEFAULT ========== #}
    {% else %}
        <div class="segment-main">
            <span class="detail-value">{{ d.descripcion or viaje.descripcion or 'Reserva' }}</span>
        </div>
        {% if viaje.origen and viaje.destino %}
            <div class="segment-route">
                <span class="route-point">{{ viaje.origen }}</span>
                <span class="route-arrow">→</span>
                <span class="route-point">{{ viaje.destino }}</span>
            </div>
        {% endif %}
    {% endif %}
</div>
